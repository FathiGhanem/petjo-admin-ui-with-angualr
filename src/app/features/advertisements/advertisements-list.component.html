<p-toast />
<p-confirmDialog />

<div class="page-container">
  <div class="page-header">
    <div>
      <h1>Advertisements</h1>
      <p class="subtitle">Review and manage advertisement requests</p>
    </div>
  </div>

  <!-- Tab View -->
  <div class="tabs-wrapper">
    <div class="tab-buttons">
      @for (tab of tabs; track tab.value) {
        <button class="tab-btn" [class.active]="activeTab === tab.value"
                (click)="switchTab(tab.value)">
          {{ tab.label }}
          @if (tab.value === 'pending' && pendingCount() > 0) {
            <span class="tab-badge">{{ pendingCount() }}</span>
          }
        </button>
      }
    </div>
  </div>

  <p-card>
    <p-table
      [value]="ads()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="20"
      [rowsPerPageOptions]="[10, 20, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
      [globalFilterFields]="['title', 'description', 'user_email']"
      #dt
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="caption">
        <div class="table-header">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText type="text" placeholder="Search ads..."
                   (input)="dt.filterGlobal($any($event.target).value, 'contains')" />
          </span>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="title">Title <p-sortIcon field="title" /></th>
          <th>Description</th>
          <th>User</th>
          <th>Phone</th>
          <th pSortableColumn="status">Status <p-sortIcon field="status" /></th>
          <th pSortableColumn="created_at">Submitted <p-sortIcon field="created_at" /></th>
          <th style="width: 160px">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-ad>
        <tr>
          <td>
            <span class="ad-title" pTooltip="{{ ad.title }}" tooltipPosition="top">
              {{ ad.title }}
            </span>
          </td>
          <td>
            <span class="ad-desc">{{ (ad.description || '') | slice:0:80 }}{{ (ad.description?.length || 0) > 80 ? '...' : '' }}</span>
          </td>
          <td>{{ ad.user_email || ad.user_name || '—' }}</td>
          <td>{{ ad.contact_phone || '—' }}</td>
          <td>
            <span class="status-badge" [class]="getStatusClass(ad.status)">
              {{ ad.status }}
            </span>
          </td>
          <td>{{ ad.created_at | date:'mediumDate' }}</td>
          <td>
            <div class="action-buttons">
              <button pButton icon="pi pi-eye" severity="info"
                      [text]="true" [rounded]="true" size="small"
                      pTooltip="View Details" tooltipPosition="top"
                      (click)="viewAd(ad)"></button>
              @if (ad.status === 'pending') {
                <button pButton icon="pi pi-check" severity="success"
                        [text]="true" [rounded]="true" size="small"
                        pTooltip="Approve" tooltipPosition="top"
                        (click)="openReviewDialog(ad, 'approved')"></button>
                <button pButton icon="pi pi-times" severity="danger"
                        [text]="true" [rounded]="true" size="small"
                        pTooltip="Reject" tooltipPosition="top"
                        (click)="openReviewDialog(ad, 'rejected')"></button>
              }
              <button pButton icon="pi pi-trash" severity="danger"
                      [text]="true" [rounded]="true" size="small"
                      pTooltip="Delete" tooltipPosition="top"
                      (click)="confirmDelete(ad)"></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7">
            <div class="empty-state">
              <i class="pi pi-megaphone"></i>
              <h3>No advertisements</h3>
              <p>No advertisements match your current filter</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Review Dialog -->
<p-dialog [header]="reviewAction === 'approved' ? 'Approve Advertisement' : 'Reject Advertisement'"
          [(visible)]="reviewDialogVisible" [modal]="true" [style]="{ width: '480px' }">
  @if (reviewingAd()) {
    <div class="review-ad-info">
      <h4>{{ reviewingAd()!.title }}</h4>
      <p>{{ reviewingAd()!.description }}</p>
    </div>
    <div class="form-field">
      <label>Admin Notes (optional)</label>
      <textarea pTextarea [(ngModel)]="adminNotes" [rows]="3"
                placeholder="Add a note..." class="w-full"></textarea>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" [text]="true"
              (onClick)="reviewDialogVisible = false" />
    <p-button [label]="reviewAction === 'approved' ? 'Approve' : 'Reject'"
              [icon]="reviewAction === 'approved' ? 'pi pi-check' : 'pi pi-times'"
              [severity]="reviewAction === 'approved' ? 'success' : 'danger'"
              (onClick)="submitReview()" />
  </ng-template>
</p-dialog>

<!-- View Dialog -->
<p-dialog header="Advertisement Details" [(visible)]="viewDialogVisible"
          [modal]="true" [style]="{ width: '560px' }">
  @if (viewingAd()) {
    <div class="ad-detail">
      <div class="detail-row">
        <span class="detail-label">Title</span>
        <span class="detail-value">{{ viewingAd()!.title }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Description</span>
        <span class="detail-value">{{ viewingAd()!.description }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Contact Phone</span>
        <span class="detail-value">{{ viewingAd()!.contact_phone || '—' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Status</span>
        <span class="status-badge" [class]="getStatusClass(viewingAd()!.status)">{{ viewingAd()!.status }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">User</span>
        <span class="detail-value">{{ viewingAd()!.user_email || '—' }}</span>
      </div>
      @if (viewingAd()!.admin_notes) {
        <div class="detail-row">
          <span class="detail-label">Admin Notes</span>
          <span class="detail-value">{{ viewingAd()!.admin_notes }}</span>
        </div>
      }
      <div class="detail-row">
        <span class="detail-label">Submitted</span>
        <span class="detail-value">{{ viewingAd()!.created_at | date:'medium' }}</span>
      </div>
      @if (viewingAd()!.reviewed_at) {
        <div class="detail-row">
          <span class="detail-label">Reviewed</span>
          <span class="detail-value">{{ viewingAd()!.reviewed_at | date:'medium' }}</span>
        </div>
      }
    </div>
  }
</p-dialog>
