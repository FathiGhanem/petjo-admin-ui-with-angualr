<p-toast />
<p-confirmDialog />

<div class="page-container">
  <div class="page-header">
    <div>
      <h1>Hero Section</h1>
      <p class="subtitle">Manage homepage hero banner items</p>
    </div>
    <div class="page-actions">
      <p-button label="Add Hero" icon="pi pi-plus" severity="primary"
                (onClick)="openCreateDialog()" />
    </div>
  </div>

  <!-- Hero Grid -->
  @if (loading()) {
    <div class="heroes-grid">
      @for (i of [1,2,3]; track i) {
        <div class="hero-card skeleton-card">
          <div class="skeleton-img"></div>
          <div class="skeleton-text"></div>
        </div>
      }
    </div>
  } @else if (heroes().length === 0) {
    <p-card>
      <div class="empty-state">
        <i class="pi pi-star"></i>
        <h3>No hero items</h3>
        <p>Create hero banners for the homepage</p>
        <p-button label="Add First Hero" icon="pi pi-plus" severity="primary"
                  (onClick)="openCreateDialog()" [style]="{ 'margin-top': '1rem' }" />
      </div>
    </p-card>
  } @else {
    <div class="heroes-grid">
      @for (hero of heroes(); track hero.id) {
        <div class="hero-card">
          <div class="hero-image">
            @if (hero.img_path) {
              <img [src]="hero.img_path" [alt]="'Hero ' + hero.id" />
            } @else {
              <div class="no-image-placeholder">
                <i class="pi pi-image"></i>
                <span>No image</span>
              </div>
            }
          </div>
          <div class="hero-info">
            <div class="hero-meta">
              <span class="hero-id">#{{ hero.id }}</span>
              <span class="hero-date">{{ hero.created_at | date:'mediumDate' }}</span>
            </div>
            @if (hero.link) {
              <a [href]="hero.link" target="_blank" rel="noopener" class="hero-link">
                <i class="pi pi-external-link"></i>
                {{ hero.link | slice:0:40 }}{{ hero.link.length > 40 ? '...' : '' }}
              </a>
            } @else {
              <span class="no-link">No link</span>
            }
            <div class="hero-actions">
              <p-button icon="pi pi-pencil" severity="info" [outlined]="true"
                        size="small" pTooltip="Edit" tooltipPosition="top"
                        (onClick)="openEditDialog(hero)" />
              <p-button icon="pi pi-trash" severity="danger" [outlined]="true"
                        size="small" pTooltip="Delete" tooltipPosition="top"
                        (onClick)="confirmDelete(hero)" />
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Create/Edit Dialog -->
<p-dialog [header]="editingHero() ? 'Edit Hero' : 'New Hero'"
          [(visible)]="dialogVisible" [modal]="true" [style]="{ width: '540px' }"
          [closable]="!saving()">

  <!-- Upload zone -->
  <div class="form-field">
    <label>Hero Image {{ editingHero() ? '(leave empty to keep current)' : '*' }}</label>

    @if (!selectedFile && !imagePreview) {
      <!-- Dropzone -->
      <div class="upload-zone" [class.drag-over]="dragOver"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           (click)="fileInput.click()">
        <input #fileInput type="file" hidden
               accept="image/jpeg,image/png,image/webp,image/heic"
               (change)="onFileSelected($event)" />
        <i class="pi pi-cloud-upload"></i>
        <span class="upload-title">Drop image here or click to browse</span>
        <span class="upload-hint">JPEG, PNG, WebP or HEIC â€” Max 10 MB</span>
      </div>
    } @else {
      <!-- Preview card -->
      <div class="preview-card">
        <div class="preview-image">
          <img [src]="imagePreview" alt="Preview" />
        </div>
        <div class="preview-info">
          @if (selectedFile) {
            <span class="file-name">{{ selectedFile.name }}</span>
            <span class="file-size">{{ formatFileSize(selectedFile.size) }}</span>
          } @else {
            <span class="file-name">Current image</span>
            <span class="file-size">Stored in bucket</span>
          }
        </div>
        <div class="preview-actions">
          <button pButton icon="pi pi-refresh" severity="secondary"
                  [rounded]="true" size="small" [text]="true"
                  pTooltip="Change image" tooltipPosition="top"
                  (click)="fileInput2.click()" [disabled]="saving()"></button>
          @if (selectedFile) {
            <button pButton icon="pi pi-times" severity="danger"
                    [rounded]="true" size="small" [text]="true"
                    pTooltip="Remove" tooltipPosition="top"
                    (click)="removeSelectedFile()" [disabled]="saving()"></button>
          }
          <input #fileInput2 type="file" hidden
                 accept="image/jpeg,image/png,image/webp,image/heic"
                 (change)="onFileSelected($event)" />
        </div>
      </div>
    }

    @if (fileError) {
      <small class="file-error"><i class="pi pi-exclamation-circle"></i> {{ fileError }}</small>
    }
  </div>

  <!-- Link field -->
  <div class="form-field">
    <label>Link (optional)</label>
    <input pInputText [(ngModel)]="formLink" placeholder="https://..."
           class="w-full" [disabled]="saving()" />
  </div>

  <!-- Saving progress -->
  @if (saving()) {
    <p-progressBar mode="indeterminate" [style]="{ height: '4px', 'margin-top': '0.5rem' }" />
  }

  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" [text]="true"
              (onClick)="dialogVisible = false" [disabled]="saving()" />
    <p-button [label]="saving() ? 'Uploading...' : (editingHero() ? 'Update' : 'Create')"
              [icon]="saving() ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
              severity="primary"
              [disabled]="saving() || (!editingHero() && !selectedFile)"
              (onClick)="save()" />
  </ng-template>
</p-dialog>
